name: Discord Notifications

on:
  push:
    branches: [ "main" ]
  release:
    types: [ published ]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord message
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          REPO: ${{ github.repository }}
          ACTOR: ${{ github.actor }}
          REF: ${{ github.ref_name }}
          EVENT: ${{ github.event_name }}
          COMMIT_MSG: ${{ github.event.head_commit.message }}
          COMMIT_URL: ${{ github.event.head_commit.url }}
          RELEASE_URL: ${{ github.event.release.html_url }}
          RELEASE_TAG: ${{ github.event.release.tag_name }}
          RELEASE_NAME: ${{ github.event.release.name }}
        run: |
          if [ -z "$DISCORD_WEBHOOK" ]; then
            echo "Missing DISCORD_WEBHOOK secret" >&2
            exit 1
          fi

          if [ "$EVENT" = "release" ]; then
            content="**New Release:** ${REPO}\n**${RELEASE_NAME:-$RELEASE_TAG}**\n${RELEASE_URL}"
          else
            content="**Push:** ${REPO}\n**Branch:** ${REF}\n**By:** ${ACTOR}\n**Message:** ${COMMIT_MSG}\n${COMMIT_URL}"
          fi

          json=$(printf '{"content":"%s"}' "$(echo "$content" | sed 's/\\/\\\\/g; s/"/\\"/g')")
          curl -sS -H "Content-Type: application/json" -X POST -d "$json" "$DISCORD_WEBHOOK"
